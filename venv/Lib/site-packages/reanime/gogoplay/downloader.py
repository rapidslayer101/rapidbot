from bs4 import BeautifulSoup
import requests,os
import re
import sys
from bs4 import BeautifulSoup
import threading
from . import downloadmanager
global l_720,l_1080,l_480,storage
def link_1080(url,s):
	global l_1080
	l_1080=None
	for i in url:
		temp=i.find('a')
		if "1080" in temp.text:
			r=s.head(str(temp.get('href')))
			if 'Location' in r.headers and r.headers['Location']!="":
				l_1080=r.headers['Location']

def link_720(url,s):
	global l_720
	l_720=None
	for i in url:
		temp=i.find('a')
		if "720" in temp.text:
			r=s.head(str(temp.get('href')))
			if 'Location' in r.headers and r.headers['Location']!="":
				l_720=r.headers['Location']

def link_480(url,s):
	global l_480
	l_480=None
	for i in url:
		temp=i.find('a')
		if "480" in temp.text:
			r=s.head(str(temp.get('href')))
			if 'Location' in r.headers and r.headers['Location']!="":
				l_480=r.headers['Location']

def hdp(url,s):
	global storage
	storage=None
	for i in url:
		temp=i.find('a')
		if "HDP" in temp.text:
			storage=temp.get('href')
		

def episode_download(url,filename,directory,resl,thread):
	s=requests.Session()
	try:
		r=requests.get(url).text
		soup=BeautifulSoup(r,'html.parser')
		stream_url="https:"+soup.find('div',attrs={'class':'play-video'}).find('iframe').get('src')
		code=re.search('id=(.*)&title',stream_url).group()[3:-6]
		for i in ['=']:
			code=code.replace(i,'')
		downurl="https://gogo-play.net/download?id="+code
		r=requests.get(downurl).text
		link1=BeautifulSoup(r,'html.parser').find_all('div',attrs={'class':'dowload'})		
	except:
		print("error")
		exit()
	t1=threading.Thread(target=link_1080,args=(link1,s,))
	t2=threading.Thread(target=link_720,args=(link1,s,))
	t3=threading.Thread(target=link_480,args=(link1,s,))
	t4=threading.Thread(target=hdp,args=(link1,s,))
	t1.start()
	t2.start()
	t3.start()
	t4.start()
	t1.join()
	t2.join()
	t3.join()
	t4.join()
	if resl=="1080":
		if storage!=None:
			downloadmanager.idmm(storage,filename,directory,thread)
		else:
			if l_1080!=None:
				downloadmanager.idmm(l_1080,filename,directory,thread)
			else:
				if l_720!=None:
					downloadmanager.idmm(l_720,filename,directory,thread)
				else:
					if l_480!=None:
						downloadmanager.idmm(l_480,filename,directory,thread)
					else:
						print("Not available")

	elif resl=="720":
		if l_720!=None:
			downloadmanager.idmm(l_720,filename,directory,thread)
		else:
			if l_480!=None:
				downloadmanager.idmm(l_480,filename,directory,thread)
			else:
				if l_1080!=None:
					downloadmanager.idmm(l_1080,filename,directory,thread)
				else:
					if storage!=None:
						downloadmanager.idmm(storage,filename,directory,thread)
					else:
						print("not available")

	elif resl=="480":
		if l_480!=None:
			downloadmanager.idmm(l_480,filename,directory,thread)
		else:
			if l_720!=None:
				downloadmanager.idmm(l_720,filename,directory,thread)
			else:
				if l_1080!=None:
					downloadmanager.idmm(l_1080,filename,directory,thread)
				else:
					if storage!=None:
						downloadmanager.idmm(storage,filename,directory,thread)
					else:
						print("not available")


def download(url,start,end,down_dir,resolution,thread):
	ind=url.index('-episode-')
	org_req_url=url[:ind]
	f=org_req_url.rfind('/')
	org_filename=url[f+1:ind]
	for i in range(start,end+1):
		req_url=org_req_url+"-episode-"+str(i)
		file_name=org_filename+"-episode-"+str(i)
		episode_download(req_url,file_name,down_dir,resolution,thread)
